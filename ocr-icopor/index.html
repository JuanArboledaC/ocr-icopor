<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Cotizador ICOPOR PRO</title>

<style>
body{
    font-family:Arial;
    background:#f4f6f9;
    padding:30px;
}
.container{
    display:flex;
    gap:30px;
}
.card{
    background:white;
    padding:20px;
    border-radius:10px;
    width:100%;
    box-shadow:0 4px 10px rgba(0,0,0,0.08);
}
textarea{
    width:100%;
    height:150px;
}
button{
    padding:10px 20px;
    border:none;
    border-radius:6px;
    cursor:pointer;
    margin-top:10px;
}
.blue{background:#2563eb;color:white;}
.green{background:#16a34a;color:white;}
table{
    width:100%;
    border-collapse:collapse;
    margin-top:15px;
}
th,td{
    border:1px solid #ddd;
    padding:8px;
    text-align:center;
}
th{
    background:#eee;
}
.totalBox{
    margin-top:15px;
    text-align:right;
    font-size:18px;
}
</style>
</head>

<body>

<h2>ICOPOR — Cotizador m³</h2>

<div class="container">

<div class="card">
<h3>1) Texto OCR</h3>
<textarea id="ocrText" placeholder="Ejemplo:
2-250*280
1 142*228"></textarea>
<button id="btnGenerateTable" class="green">Generar Tabla</button>
</div>

<div class="card">
<h3>2) Datos Cotización</h3>

<label>Precio por m³</label>
<input id="precioM3" type="text" value="300000"><br><br>

<label>Altura (cm) — aplica a todas</label>
<input id="altura" type="number" value="5"><br><br>

<label>IVA (%)</label>
<input id="iva" type="number" value="19"><br>

<table id="cotTable">
<thead>
<tr>
<th>Cant</th>
<th>Largo (cm)</th>
<th>Ancho (cm)</th>
<th>m³</th>
<th>Total Línea</th>
</tr>
</thead>
<tbody></tbody>
</table>

<div class="totalBox">
Subtotal: <span id="subtotal">$0</span><br>
IVA: <span id="ivaAmt">$0</span><br>
<strong>Total: <span id="totalAmt">$0</span></strong>
</div>

</div>
</div>

<script>

const $ = id => document.getElementById(id);

function formatMoney(v){
  return new Intl.NumberFormat('es-CO',{
    style:'currency',
    currency:'COP',
    minimumFractionDigits:0
  }).format(v);
}

function parsePrice(){
  let v = $('precioM3').value || "0";
  v = v.replace(/\./g,'').replace(/,/g,'');
  return parseFloat(v) || 0;
}

$('precioM3').addEventListener('blur',()=>{
  $('precioM3').value =
    new Intl.NumberFormat('es-CO').format(parsePrice());
});

function extraerLineas(texto){

  const lineas = texto.split(/\r?\n/);
  const resultado = [];

  lineas.forEach(l=>{
    l = l.trim();
    if(!l) return;

    const match = l.match(/^(\d+)?\s*[- ]?\s*(\d+)\s*[xX\*]\s*(\d+)/);

    if(match){
      let cantidad = match[1] ? parseInt(match[1]) : 1;
      let largo    = parseInt(match[2]);
      let ancho    = parseInt(match[3]);
      resultado.push({cantidad,largo,ancho});
    }

  });

  return resultado;
}

function limpiarTabla(){
  $('cotTable').querySelector('tbody').innerHTML="";
}

function agregarFila(obj){

  const tbody = $('cotTable').querySelector('tbody');
  const tr = document.createElement('tr');

  tr.innerHTML=`
    <td contenteditable class="cCant">${obj.cantidad}</td>
    <td contenteditable class="cLargo">${obj.largo}</td>
    <td contenteditable class="cAncho">${obj.ancho}</td>
    <td class="cM3">0</td>
    <td class="cTotal">$0</td>
  `;

  tbody.appendChild(tr);

  tr.querySelectorAll('[contenteditable]').forEach(c=>{
    c.addEventListener('input',()=>{
      recalcularFila(tr);
      recalcularTotales();
    });
  });

  recalcularFila(tr);
}

function recalcularFila(tr){

  const altura_cm = parseFloat($('altura').value)||0;
  const precio = parsePrice();

  const cant  = parseFloat(tr.querySelector('.cCant').innerText)||0;
  const largo = parseFloat(tr.querySelector('.cLargo').innerText)||0;
  const ancho = parseFloat(tr.querySelector('.cAncho').innerText)||0;

  const m3 =
    (largo/100) *
    (ancho/100) *
    (altura_cm/100) *
    cant;

  const total = m3 * precio;

  tr.querySelector('.cM3').innerText =
    m3.toFixed(4);

  tr.querySelector('.cTotal').innerText =
    formatMoney(Math.round(total));
}

function recalcularTotales(){

  let subtotal = 0;

  document.querySelectorAll('.cTotal').forEach(td=>{
    const v = Number(td.innerText.replace(/[^0-9]/g,''))||0;
    subtotal+=v;
  });

  const ivaPct = parseFloat($('iva').value)||0;
  const iva = subtotal*(ivaPct/100);
  const total = subtotal+iva;

  $('subtotal').innerText = formatMoney(subtotal);
  $('ivaAmt').innerText   = formatMoney(iva);
  $('totalAmt').innerText = formatMoney(total);
}

$('btnGenerateTable').addEventListener('click',()=>{

  limpiarTabla();

  const texto = $('ocrText').value;
  const data = extraerLineas(texto);

  data.forEach(d=>agregarFila(d));

  recalcularTotales();
});

$('altura').addEventListener('input',()=>{
  document.querySelectorAll('#cotTable tbody tr')
  .forEach(tr=>recalcularFila(tr));
  recalcularTotales();
});

$('iva').addEventListener('input',recalcularTotales);

</script>

</body>
</html>

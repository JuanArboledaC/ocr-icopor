<script>

const $ = id => document.getElementById(id);

function formatMoney(v){
  return new Intl.NumberFormat('es-CO',{
    style:'currency',
    currency:'COP',
    minimumFractionDigits:0
  }).format(v);
}

function parsePrice(){
  let v = $('precioM3').value || "0";
  v = v.replace(/\./g,'').replace(/,/g,'');
  return parseFloat(v) || 0;
}

$('precioM3').addEventListener('blur',()=>{
  $('precioM3').value =
    new Intl.NumberFormat('es-CO').format(parsePrice());
});

function extraerLineas(texto){

  const lineas = texto.split(/\r?\n/);
  const resultado = [];

  lineas.forEach(l=>{
    l = l.trim();
    if(!l) return;

    // Captura:
    // 2-250*280
    // 2 250*280
    // 250*280
    const match = l.match(/^(\d+)?\s*[- ]?\s*(\d+)\s*[xX\*]\s*(\d+)/);

    if(match){

      let cantidad = match[1] ? parseInt(match[1]) : 1;
      let largo    = parseInt(match[2]);
      let ancho    = parseInt(match[3]);

      resultado.push({cantidad,largo,ancho});
    }

  });

  return resultado;
}

function limpiarTabla(){
  document.querySelector('#cotTable tbody').innerHTML="";
  recalcularTotales();
}

function agregarFila(obj){

  const tbody = document.querySelector('#cotTable tbody');

  const tr = document.createElement('tr');

  tr.innerHTML=`
    <td contenteditable class="cCant">${obj.cantidad}</td>
    <td contenteditable class="cLargo">${obj.largo}</td>
    <td contenteditable class="cAncho">${obj.ancho}</td>
    <td class="cM3">0</td>
    <td class="cTotal">$0</td>
  `;

  tbody.appendChild(tr);

  tr.querySelectorAll('[contenteditable]').forEach(c=>{
    c.addEventListener('input',()=>{
      recalcularFila(tr);
      recalcularTotales();
    });
  });

  recalcularFila(tr);
}

function recalcularFila(tr){

  const altura_cm = parseFloat($('altura').value)||0;
  const precio = parsePrice();

  const cant  = parseFloat(tr.querySelector('.cCant').innerText)||0;
  const largo = parseFloat(tr.querySelector('.cLargo').innerText)||0;
  const ancho = parseFloat(tr.querySelector('.cAncho').innerText)||0;

  const m3 =
    (largo/100) *
    (ancho/100) *
    (altura_cm/100) *
    cant;

  const total = m3 * precio;

  tr.querySelector('.cM3').innerText =
    m3.toFixed(4);

  tr.querySelector('.cTotal').innerText =
    formatMoney(Math.round(total));
}

function recalcularTotales(){

  let subtotal = 0;

  document.querySelectorAll('.cTotal').forEach(td=>{
    const v = Number(td.innerText.replace(/[^0-9]/g,''))||0;
    subtotal+=v;
  });

  const ivaPct = parseFloat($('iva').value)||0;
  const iva = subtotal*(ivaPct/100);
  const total = subtotal+iva;

  $('subtotal').innerText = formatMoney(subtotal);
  $('ivaAmt').innerText   = formatMoney(iva);
  $('totalAmt').innerText = formatMoney(total);
}

$('btnGenerateTable').addEventListener('click',()=>{

  const texto = $('ocrText').value;
  const data = extraerLineas(texto);

  limpiarTabla();

  data.forEach(d=>agregarFila(d));

  recalcularTotales();
});

$('altura').addEventListener('input',()=>{
  document.querySelectorAll('#cotTable tbody tr')
  .forEach(tr=>recalcularFila(tr));
  recalcularTotales();
});

$('iva').addEventListener('input',recalcularTotales);

</script>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OCR PRO ICOPOR</title>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f4f6f9;
    padding: 40px;
}

h2 {
    margin-bottom: 20px;
}

button {
    padding: 10px 20px;
    margin: 5px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
}

.blue { background: #2563eb; color: white; }
.red { background: #dc2626; color: white; }

#preview {
    max-width: 500px;
    margin-top: 20px;
    display: block;
}

textarea {
    width: 100%;
    height: 180px;
    margin-top: 20px;
    padding: 10px;
    font-family: monospace;
}
</style>
</head>

<body>

<h2>OCR PRO ICOPOR (Google Vision)</h2>

<input type="file" id="imageInput" accept="image/*">
<button class="blue" onclick="procesar()">Leer con IA</button>
<button class="red" onclick="limpiar()">Limpiar</button>

<img id="preview">

<textarea id="resultado" placeholder="Aquí aparecerá el texto detectado por la IA..."></textarea>

<script>

let base64Image = "";

// Cuando el usuario selecciona imagen
document.getElementById("imageInput").addEventListener("change", function(e) {

    const file = e.target.files[0];
    if(!file) return;

    const reader = new FileReader();

    reader.onload = function() {
        document.getElementById("preview").src = reader.result;

        // Quitamos encabezado data:image/...;
        base64Image = reader.result.split(",")[1];
    };

    reader.readAsDataURL(file);
});


// Enviar imagen a Netlify Function
async function procesar() {

    if(!base64Image){
        alert("Primero debes subir una imagen.");
        return;
    }

    document.getElementById("resultado").value = "Procesando con Google Vision...";

    try {

        const response = await fetch("/.netlify/functions/vision", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ image: base64Image })
        });

        const data = await response.json();

        if(data.responses && data.responses[0].fullTextAnnotation){
            document.getElementById("resultado").value =
                data.responses[0].fullTextAnnotation.text;
        } else {
            document.getElementById("resultado").value = "No se detectó texto.";
        }

    } catch(error) {
        document.getElementById("resultado").value = "Error: " + error.message;
    }
}


// Limpiar pantalla
function limpiar(){
    document.getElementById("resultado").value = "";
    document.getElementById("preview").src = "";
    document.getElementById("imageInput").value = "";
    base64Image = "";
}

</script>

</body>
</html>

<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ICOPOR — Cotizador m³ (OCR + PDF)</title>

<!-- jsPDF + AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>
  /* --- Corporate header --- */
  body{font-family:Arial,Helvetica,sans-serif;background:#f3f4f6;margin:0;}
  .topbar{background:#0b63d6;color:#fff;padding:18px 24px;box-shadow:0 4px 10px rgba(11,99,214,0.15)}
  .topbar h1{margin:0;font-size:20px;font-weight:700}
  .container{padding:24px}

  /* --- Cards & layout --- */
  .row{display:flex;gap:20px;flex-wrap:wrap}
  .card{background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06);flex:1;min-width:320px}
  label{font-weight:600;font-size:13px;display:block;margin-top:8px}
  input, textarea, select {width:100%;padding:9px;margin-top:6px;border:1px solid #ddd;border-radius:6px;box-sizing:border-box}
  textarea{height:160px;font-family:monospace}
  img#preview{max-width:100%;border-radius:6px;margin-top:8px;display:none;border:1px solid #eee}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid #e6e6e6;padding:8px;text-align:center}
  th{background:#fafafa;color:#333}
  .btn{display:inline-block;padding:10px 14px;border-radius:8px;border:none;color:#fff;cursor:pointer;margin-top:10px}
  .btn-blue{background:#0b63d6}
  .btn-green{background:#059669}
  .btn-red{background:#dc2626}
  .totals{margin-top:12px;text-align:right}
  .subtotal,.iva-line{color:#333}
  .total-strong{font-weight:800;font-size:20px;color:#0b63d6}
  .meta-small{font-size:12px;color:#666;margin-top:8px}
  /* responsive */
  @media(max-width:900px){ .row{flex-direction:column} }
</style>
</head>
<body>

<div class="topbar">
  <h1>ICOPOR — Cotizador m³ (OCR → Cotización PDF)</h1>
</div>

<div class="container">
  <div class="row">
    <!-- LEFT: OCR -->
    <div class="card">
      <h3>1) Subir imagen y extraer texto (OCR)</h3>

      <label>Imagen (foto / escaneo)</label>
      <input type="file" id="imageInput" accept="image/*">

      <img id="preview" alt="preview">

      <div style="margin-top:10px">
        <button class="btn btn-blue" onclick="leerImagen()">Leer Imagen (Vision)</button>
        <button class="btn btn-red" onclick="limpiarOCR()">Limpiar</button>
      </div>

      <label>Texto detectado (editable)</label>
      <textarea id="texto" placeholder="Ejemplo:
2-250*280
3-150x370
1 142*228"></textarea>

      <div>
        <button class="btn btn-green" onclick="generarTabla()">Generar Tabla</button>
        <div class="meta-small">Si OCR falla, corrige el texto y pulsa "Generar Tabla".</div>
      </div>
    </div>

    <!-- RIGHT: Cotización -->
    <div class="card">
      <h3>2) Datos de la cotización</h3>

      <label>Cliente</label>
      <input id="cliente" placeholder="Nombre del cliente">

      <label>Precio por m³ (COP) — acepta 300000 o 300.000</label>
      <input id="precio" value="300000">

      <label>Altura (cm) — se aplica a todas las líneas</label>
      <input id="altura" type="number" value="30">

      <label>IVA (%)</label>
      <input id="iva" type="number" value="19">

      <label>Logo (opcional) — se incluye en PDF</label>
      <input id="logoInput" type="file" accept="image/*">

      <div style="margin-top:12px">
        <strong id="numeroCot">N° Cotización: 000</strong>
      </div>

      <h4 style="margin-top:12px">Tabla (generada)</h4>
      <table>
        <thead>
          <tr><th>Cant</th><th>Largo (cm)</th><th>Ancho (cm)</th><th>Altura (cm)</th><th>m³</th><th>Total Línea (COP)</th></tr>
        </thead>
        <tbody id="tablaBody"></tbody>
      </table>

      <div class="totals">
        <div class="subtotal" id="subtotal">Subtotal: $ 0</div>
        <div class="iva-line" id="ivaValor">IVA: $ 0</div>
        <div class="total-strong" id="totalFinal">Total: $ 0</div>
      </div>

      <div style="margin-top:14px">
        <button class="btn btn-blue" onclick="generarPDF()">Generar PDF</button>
      </div>
    </div>
  </div>
</div>

<script>
/* -------------------------
   Variables y utilidades
   ------------------------- */
let base64Image = "";
let base64Logo = "";
let cotNumero = parseInt(localStorage.getItem("cot_num") || "1", 10);
function actualizarNumeroUI(){ document.getElementById("numeroCot").innerText = "N° Cotización: " + String(cotNumero).padStart(3,"0"); }
actualizarNumeroUI();

function fmtNumber(n){
  if(isNaN(n)) n = 0;
  return n.toLocaleString('es-CO',{maximumFractionDigits:0});
}
function safeParsePrice(str){
  if(typeof str !== "string") str = String(str||"");
  str = str.replace(/\./g,"").replace(/,/g,"").replace(/\s/g,"");
  const p = parseFloat(str);
  return isNaN(p)?0:p;
}

/* -------------------------
   Preview + uploads
   ------------------------- */
document.getElementById("imageInput").addEventListener("change", function(e){
  const f = e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = ()=> {
    document.getElementById("preview").src = r.result;
    document.getElementById("preview").style.display = "block";
    base64Image = r.result.split(",")[1];
  };
  r.readAsDataURL(f);
});

document.getElementById("logoInput").addEventListener("change", function(e){
  const f = e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = ()=> { base64Logo = r.result.split(",")[1]; };
  r.readAsDataURL(f);
});

/* -------------------------
   OCR (Netlify function)
   ------------------------- */
async function leerImagen(){
  if(!base64Image){ alert("Sube una imagen primero."); return; }
  document.getElementById("texto").value = "Procesando...";
  try{
    const resp = await fetch("/.netlify/functions/vision", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ image: base64Image })
    });
    const data = await resp.json();
    if(data && data.responses && data.responses[0] && data.responses[0].fullTextAnnotation){
      document.getElementById("texto").value = data.responses[0].fullTextAnnotation.text;
    } else {
      console.warn("Vision response fallback:", data);
      document.getElementById("texto").value = (data.responses && JSON.stringify(data.responses)) || "No se detectó texto claro.";
    }
  } catch(err){
    console.error(err);
    document.getElementById("texto").value = "Error al llamar a la función OCR: " + (err.message || err);
  }
}

function limpiarOCR(){
  document.getElementById("texto").value = "";
  document.getElementById("preview").src = "";
  document.getElementById("preview").style.display = "none";
  base64Image = "";
}

/* -------------------------
   Parseo de líneas (robusto)
   ------------------------- */
function parseLine(line){
  if(!line) return null;
  let raw = line.trim();
  raw = raw.replace(/×/gi,'x').replace(/X/gi,'x');
  raw = raw.replace(/=/g,' ').replace(/:/g,' ').replace(/,/g,' ').replace(/\s+/g,' ');
  const nums = raw.match(/\d+/g);
  if(!nums || nums.length < 2) return null;

  // patrón "count - largo x ancho"
  const p1 = raw.match(/^\s*(\d+)\s*[-]\s*(\d+)\s*[x*]\s*(\d+)/i);
  if(p1) return { count: parseInt(p1[1],10), largo: parseInt(p1[2],10), ancho: parseInt(p1[3],10) };

  // patrón "count largo x ancho" (sin guion)
  const p2 = raw.match(/^\s*(\d+)\s+(\d+)\s*[x*]\s*(\d+)/i);
  if(p2) return { count: parseInt(p2[1],10), largo: parseInt(p2[2],10), ancho: parseInt(p2[3],10) };

  // patrón "largo x ancho" (si hay 3 números asumimos [count,largo,ancho])
  const p3 = raw.match(/(\d+)\s*[x*]\s*(\d+)/i);
  if(p3){
    if(nums.length >= 3) return { count: parseInt(nums[0],10), largo: parseInt(nums[1],10), ancho: parseInt(nums[2],10) };
    return { count:1, largo: parseInt(p3[1],10), ancho: parseInt(p3[2],10) };
  }

  // fallback: si hay >=3 números asumimos [count,largo,ancho]
  if(nums.length >= 3) return { count: parseInt(nums[0],10), largo: parseInt(nums[1],10), ancho: parseInt(nums[2],10) };

  // si hay exactamente 2 números: largo y ancho
  if(nums.length === 2) return { count:1, largo: parseInt(nums[0],10), ancho: parseInt(nums[1],10) };

  return null;
}

/* -------------------------
   Generar tabla (UI)
   ------------------------- */
function generarTabla(){
  const texto = document.getElementById("texto").value || "";
  const precio = safeParsePrice(document.getElementById("precio").value);
  const altura = parseFloat(document.getElementById("altura").value) || 0;
  const ivaPorc = parseFloat(document.getElementById("iva").value) || 0;

  const lines = texto.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const tbody = document.getElementById("tablaBody");
  tbody.innerHTML = "";

  let subtotal = 0;
  for(const ln of lines){
    const parsed = parseLine(ln);
    if(!parsed) continue;
    const c = isNaN(parsed.count)?1:parsed.count;
    const largo = parsed.largo || 0;
    const ancho = parsed.ancho || 0;

    // m3: convertir cm -> m
    const m3 = (largo/100) * (ancho/100) * (altura/100) * c;
    const totalLinea = m3 * precio;
    subtotal += totalLinea;

    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${c}</td>
                    <td>${largo}</td>
                    <td>${ancho}</td>
                    <td>${altura}</td>
                    <td>${m3.toFixed(3)}</td>
                    <td>$ ${fmtNumber(Math.round(totalLinea))}</td>`;
    tbody.appendChild(tr);
  }

  const ivaVal = subtotal * (ivaPorc/100);
  const total = subtotal + ivaVal;

  document.getElementById("subtotal").innerText = "Subtotal: $ " + fmtNumber(Math.round(subtotal));
  document.getElementById("ivaValor").innerText = "IVA: $ " + fmtNumber(Math.round(ivaVal));
  document.getElementById("totalFinal").innerText = "Total: $ " + fmtNumber(Math.round(total));
}

/* -------------------------
   Generar PDF (logo, contactos, encabezados en negro)
   ------------------------- */
async function generarPDF(){
  const cliente = document.getElementById("cliente").value || "Cliente";
  const ivaPorc = parseFloat(document.getElementById("iva").value) || 0;

  // asegúrate de que la tabla esté actualizada
  generarTabla();

  // leer filas de la tabla
  const rows = [];
  document.querySelectorAll("#tablaBody tr").forEach(tr=>{
    const tds = tr.querySelectorAll("td");
    if(tds.length >= 6){
      // quitar símbolo $ en valor final
      const totalLineaText = tds[5].innerText.replace(/\$/g,'').replace(/\s/g,'');
      rows.push([tds[0].innerText, tds[1].innerText, tds[2].innerText, tds[3].innerText, tds[4].innerText, totalLineaText]);
    }
  });

  const subtotalText = document.getElementById("subtotal").innerText.split("$")[1] || "0";
  const ivaText = document.getElementById("ivaValor").innerText.split("$")[1] || "0";
  const totalText = document.getElementById("totalFinal").innerText.split("$")[1] || "0";

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt',format:'a4'});

  // Header - título en negro
  doc.setFont("helvetica","bold");
  doc.setFontSize(18);
  doc.setTextColor(0,0,0);
  doc.text("COTIZACIÓN ICOPOR", 40, 50);

  // logo si existe (intenta jpeg then png)
  if(base64Logo){
    try{ doc.addImage(base64Logo, 'JPEG', 440, 30, 120, 60); }
    catch(e1){
      try{ doc.addImage(base64Logo, 'PNG', 440, 30, 120, 60); }catch(e2){ console.warn("No se pudo insertar logo:", e2); }
    }
  }

  // Datos empresa (negro)
  doc.setFontSize(10);
  doc.setFont("helvetica","normal");
  doc.setTextColor(0,0,0);
  doc.text("ICOPOR DE ORIENTE", 40, 80);
  doc.text("Correo: arleyy090@gmail.com", 40, 95);
  doc.text("WhatsApp: 3127512420", 40, 110);

  // Datos cotización
  doc.text(`Cliente: ${cliente}`, 40, 135);
  doc.text(`N° Cotización: ${String(cotNumero).padStart(3,'0')}`, 40, 152);
  doc.text(`Fecha: ${new Date().toLocaleString()}`, 40, 168);

  // Tabla con autotable (encabezado en negro)
  doc.autoTable({
    startY: 190,
    head: [['Cant','Largo (cm)','Ancho (cm)','Altura (cm)','m³','Total Línea (COP)']],
    body: rows,
    styles: { fontSize: 10, textColor: [0,0,0] },
    headStyles: { fillColor: [240,240,240], textColor: [0,0,0], fontStyle: 'bold' }
  });

  const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 16 : 360;

  doc.setFontSize(11);
  doc.text(`Subtotal: $ ${fmtNumber(parseInt(subtotalText.replace(/\./g,''),10) || 0)}`, 400, finalY + 10);
  doc.text(`IVA (${ivaPorc}%): $ ${fmtNumber(parseInt(ivaText.replace(/\./g,''),10) || 0)}`, 400, finalY + 30);
  doc.setFont("helvetica","bold");
  doc.setFontSize(13);
  doc.text(`Total: $ ${fmtNumber(parseInt(totalText.replace(/\./g,''),10) || 0)}`, 400, finalY + 56);

  // Pie con contacto (negro)
  doc.setFont("helvetica","normal");
  doc.setFontSize(9);
  doc.text("ICOPOR DE ORIENTE — Correo: arleyy090@gmail.com — WhatsApp: 3127512420", 40, finalY + 90);

  const filename = `COT-${String(cotNumero).padStart(3,'0')} - ${cliente}.pdf`;
  doc.save(filename);

  // incrementar y guardar
  cotNumero++;
  localStorage.setItem("cot_num", String(cotNumero));
  actualizarNumeroUI();
}
</script>
</body>
</html>

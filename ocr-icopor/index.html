<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ICOPOR — Cotizador m³ (OCR + PDF)</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>
body{font-family:Arial,Helvetica,sans-serif;background:#f3f4f6;margin:24px;}
h1{margin:0 0 18px 0}
.row{display:flex;gap:20px;flex-wrap:wrap}
.card{background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06);flex:1;min-width:320px}
input, textarea {width:100%;padding:8px;margin:8px 0;border:1px solid #ddd;border-radius:6px}
textarea{height:160px;font-family:monospace}
img#preview{max-width:100%;border-radius:6px;margin-top:8px;display:none}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{border:1px solid #e6e6e6;padding:8px;text-align:center}
th{background:#fafafa}
.btn{display:inline-block;padding:10px 14px;border-radius:8px;border:none;color:#fff;cursor:pointer;margin-top:6px}
.btn-blue{background:#1d4ed8}
.btn-green{background:#059669}
.btn-red{background:#dc2626}
.totals{margin-top:12px;text-align:right}
.total-strong{font-weight:700;font-size:18px}
</style>
</head>

<body>
<h1>ICOPOR — Cotizador m³ (OCR → Cotización PDF)</h1>

<div class="row">
<div class="card">
<h3>1) Subir imagen y extraer texto (OCR)</h3>

<input type="file" id="imageInput" accept="image/*">
<img id="preview">

<div>
<button class="btn btn-blue" onclick="leerImagen()">Leer Imagen (Vision)</button>
<button class="btn btn-red" onclick="limpiarOCR()">Limpiar</button>
</div>

<textarea id="texto" placeholder="Ejemplo:
2-250*280
3-150x370
1 142*228"></textarea>

<button class="btn btn-green" onclick="generarTabla()">Generar Tabla</button>
</div>

<div class="card">
<h3>2) Datos de la cotización</h3>

<input id="cliente" placeholder="Nombre del cliente">
<input id="precio" value="300000">
<input id="altura" type="number" value="30">
<input id="iva" type="number" value="19">
<input id="logoInput" type="file" accept="image/*">

<strong id="numeroCot">N° Cotización: 000</strong>

<table>
<thead>
<tr>
<th>Cant</th><th>Largo (cm)</th><th>Ancho (cm)</th>
<th>Altura (cm)</th><th>m³</th><th>Total Línea (COP)</th>
</tr>
</thead>
<tbody id="tablaBody"></tbody>
</table>

<div class="totals">
<div id="subtotal">Subtotal: $ 0</div>
<div id="ivaValor">IVA: $ 0</div>
<div class="total-strong" id="totalFinal">Total: $ 0</div>
</div>

<button class="btn btn-blue" onclick="generarPDF()">Generar PDF</button>
</div>
</div>

<script>

let base64Image="";
let base64Logo="";
let cotNumero=parseInt(localStorage.getItem("cot_num")||"1",10);
function actualizarNumeroUI(){
document.getElementById("numeroCot").innerText="N° Cotización: "+String(cotNumero).padStart(3,"0");
}
actualizarNumeroUI();

function fmt(n){return n.toLocaleString('es-CO',{maximumFractionDigits:0});}
function safeParsePrice(str){
str=str.replace(/\./g,"").replace(/,/g,"").replace(/\s/g,"");
return parseFloat(str)||0;
}

document.getElementById("imageInput").addEventListener("change",e=>{
const f=e.target.files[0];
if(!f)return;
const r=new FileReader();
r.onload=()=>{
document.getElementById("preview").src=r.result;
document.getElementById("preview").style.display="block";
base64Image=r.result.split(",")[1];
};
r.readAsDataURL(f);
});

document.getElementById("logoInput").addEventListener("change",e=>{
const f=e.target.files[0];
if(!f)return;
const r=new FileReader();
r.onload=()=>{base64Logo=r.result.split(",")[1];};
r.readAsDataURL(f);
});

async function leerImagen(){
if(!base64Image){alert("Sube una imagen primero.");return;}
document.getElementById("texto").value="Procesando...";
try{
const resp=await fetch("/.netlify/functions/vision",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({image:base64Image})
});
const data=await resp.json();
if(data.responses && data.responses[0].fullTextAnnotation){
document.getElementById("texto").value=data.responses[0].fullTextAnnotation.text;
}
}catch(err){
document.getElementById("texto").value="Error OCR";
}
}

function limpiarOCR(){
document.getElementById("texto").value="";
document.getElementById("preview").style.display="none";
base64Image="";
}

function parseLine(line){
line=line.trim().replace(/×/gi,'x');
const nums=line.match(/\d+/g);
if(!nums||nums.length<2)return null;
if(nums.length===2)return{count:1,largo:+nums[0],ancho:+nums[1]};
return{count:+nums[0],largo:+nums[1],ancho:+nums[2]};
}

function generarTabla(){
const texto=document.getElementById("texto").value;
const precio=safeParsePrice(document.getElementById("precio").value);
const altura=parseFloat(document.getElementById("altura").value)||0;
const ivaPorc=parseFloat(document.getElementById("iva").value)||0;

const lines=texto.split(/\n/);
const tbody=document.getElementById("tablaBody");
tbody.innerHTML="";
let subtotal=0;

for(const l of lines){
const p=parseLine(l);
if(!p)continue;
const m3=(p.largo/100)*(p.ancho/100)*(altura/100)*p.count;
const totalLinea=m3*precio;
subtotal+=totalLinea;

tbody.innerHTML+=`
<tr>
<td>${p.count}</td>
<td>${p.largo}</td>
<td>${p.ancho}</td>
<td>${altura}</td>
<td>${m3.toFixed(3)}</td>
<td>$ ${fmt(Math.round(totalLinea))}</td>
</tr>`;
}

const ivaVal=subtotal*(ivaPorc/100);
const total=subtotal+ivaVal;

document.getElementById("subtotal").innerText="Subtotal: $ "+fmt(Math.round(subtotal));
document.getElementById("ivaValor").innerText="IVA: $ "+fmt(Math.round(ivaVal));
document.getElementById("totalFinal").innerText="Total: $ "+fmt(Math.round(total));
}

async function generarPDF(){

const cliente=document.getElementById("cliente").value||"Cliente";
const ivaPorc=parseFloat(document.getElementById("iva").value)||0;
generarTabla();

const rows=[];
document.querySelectorAll("#tablaBody tr").forEach(tr=>{
const t=tr.querySelectorAll("td");
rows.push([t[0].innerText,t[1].innerText,t[2].innerText,t[3].innerText,t[4].innerText,t[5].innerText]);
});

const {jsPDF}=window.jspdf;
const doc=new jsPDF({unit:'pt',format:'a4'});

doc.setFont("helvetica","bold");
doc.setFontSize(18);
doc.setTextColor(0,0,0);
doc.text("COTIZACIÓN ICOPOR",40,50);

if(base64Logo){
doc.addImage("data:image/jpeg;base64,"+base64Logo,'JPEG',400,30,140,70);
}

doc.setFont("helvetica","normal");
doc.setFontSize(11);
doc.text("ICOPOR DE ORIENTE",40,80);
doc.text("Correo: arleyy090@gmail.com",40,95);
doc.text("WhatsApp: 3127512420",40,110);

doc.text(`Cliente: ${cliente}`,40,135);
doc.text(`N° Cotización: ${String(cotNumero).padStart(3,'0')}`,40,150);
doc.text(`Fecha: ${new Date().toLocaleString()}`,40,165);

doc.autoTable({
startY:190,
head:[['Cant','Largo (cm)','Ancho (cm)','Altura (cm)','m³','Total Línea (COP)']],
body:rows,
styles:{textColor:[0,0,0]},
headStyles:{fillColor:[230,230,230],textColor:[0,0,0],fontStyle:'bold'}
});

const finalY=doc.lastAutoTable.finalY+20;

doc.text(document.getElementById("subtotal").innerText,400,finalY);
doc.text(document.getElementById("ivaValor").innerText,400,finalY+20);
doc.setFont("helvetica","bold");
doc.text(document.getElementById("totalFinal").innerText,400,finalY+40);

doc.setFontSize(9);
doc.setFont("helvetica","normal");
doc.text("ICOPOR DE ORIENTE — Correo: arleyy090@gmail.com — WhatsApp: 3127512420",40,finalY+70);

doc.save(`COT-${String(cotNumero).padStart(3,'0')} - ${cliente}.pdf`);

cotNumero++;
localStorage.setItem("cot_num",cotNumero);
actualizarNumeroUI();
}

</script>
</body>
</html>

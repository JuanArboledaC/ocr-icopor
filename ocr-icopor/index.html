<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cotizador ICOPOR PRO</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f3f4f6;
  padding:30px;
}

.container{
  display:flex;
  gap:30px;
}

.card{
  background:white;
  padding:20px;
  border-radius:12px;
  box-shadow:0 5px 15px rgba(0,0,0,0.05);
  flex:1;
}

h2{margin-bottom:15px;}

input, textarea{
  padding:8px;
  margin:5px 0;
  width:100%;
  border:1px solid #ddd;
  border-radius:6px;
}

button{
  padding:10px 15px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  margin-top:8px;
}

.blue{background:#2563eb;color:white;}
.green{background:#16a34a;color:white;}
.red{background:#dc2626;color:white;}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}

th, td{
  border:1px solid #ddd;
  padding:8px;
  text-align:center;
}

th{background:#f1f5f9;}

.total-section{
  margin-top:20px;
  text-align:right;
}

.total-section div{
  margin:5px 0;
  font-size:16px;
}
</style>
</head>

<body>

<h2>COTIZADOR ICOPOR PROFESIONAL</h2>

<div class="container">

<!-- OCR -->
<div class="card">
<h3>1) OCR</h3>

<input type="file" id="imageInput" accept="image/*">
<button class="blue" onclick="procesar()">Leer Imagen</button>

<textarea id="resultado" placeholder="Texto detectado"></textarea>
<button class="green" onclick="generarTabla()">Generar Tabla</button>
</div>

<!-- COTIZACIÓN -->
<div class="card">

<h3>2) Datos Cotización</h3>

<input type="text" id="cliente" placeholder="Nombre del cliente">

<label>Precio por m³</label>
<input type="number" id="precioM3" value="300000">

<label>Espesor (mm) — Se aplica a todas las líneas</label>
<input type="number" id="espesor" value="50">

<label>IVA (%)</label>
<input type="number" id="iva" value="19">

<label>Logo (opcional)</label>
<input type="file" id="logoInput">
<img id="logoPreview" style="height:60px; display:none;">

<div id="tablaContainer"></div>

<div class="total-section">
  <div>Subtotal: <span id="subtotal">$0</span></div>
  <div>IVA: <span id="valorIva">$0</span></div>
  <div><strong>Total: <span id="totalFinal">$0</span></strong></div>
</div>

</div>

</div>

<script>

let base64Image="";
let numeroCotizacion = parseInt(localStorage.getItem("numCot")) || 1;

document.getElementById("imageInput").addEventListener("change",function(e){
  const reader=new FileReader();
  reader.onload=()=>base64Image=reader.result.split(",")[1];
  reader.readAsDataURL(e.target.files[0]);
});

document.getElementById("logoInput").addEventListener("change",function(e){
  const reader=new FileReader();
  reader.onload=()=>{
    const img=document.getElementById("logoPreview");
    img.src=reader.result;
    img.style.display="block";
  }
  reader.readAsDataURL(e.target.files[0]);
});

async function procesar(){
  const response=await fetch("/.netlify/functions/vision",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({image:base64Image})
  });
  const data=await response.json();
  document.getElementById("resultado").value =
    data.responses[0].fullTextAnnotation?.text || "";
}

function generarTabla(){

  const texto=document.getElementById("resultado").value.trim();
  const lineas=texto.split("\n");
  const precio=parseFloat(document.getElementById("precioM3").value);
  const espesor=parseFloat(document.getElementById("espesor").value)/1000;

  let html=`<table>
  <tr>
    <th>Cant</th>
    <th>Ancho (mm)</th>
    <th>Alto (mm)</th>
    <th>m³</th>
    <th>Total Línea</th>
  </tr>`;

  lineas.forEach(l=>{
    const match=l.match(/(\d+)[-*](\d+)[xX*](\d+)/);
    if(match){
      html+=`<tr>
        <td contenteditable="true">${match[1]}</td>
        <td contenteditable="true">${match[2]}</td>
        <td contenteditable="true">${match[3]}</td>
        <td class="m3">0</td>
        <td class="totalLinea">0</td>
      </tr>`;
    }
  });

  html+="</table>";
  document.getElementById("tablaContainer").innerHTML=html;

  recalcular();
}

function recalcular(){

  const precio=parseFloat(document.getElementById("precioM3").value);
  const espesor=parseFloat(document.getElementById("espesor").value)/1000;
  const filas=document.querySelectorAll("table tr");

  let subtotal=0;

  filas.forEach((fila,i)=>{
    if(i===0) return;

    const celdas=fila.querySelectorAll("td");

    const cant=parseFloat(celdas[0].innerText)||0;
    const ancho=parseFloat(celdas[1].innerText)/1000||0;
    const alto=parseFloat(celdas[2].innerText)/1000||0;

    const m3=cant*ancho*alto*espesor;
    const totalLinea=m3*precio;

    celdas[3].innerText=m3.toFixed(3);
    celdas[4].innerText=formatear(totalLinea);

    subtotal+=totalLinea;
  });

  const ivaPorc=parseFloat(document.getElementById("iva").value)||0;
  const valorIva=subtotal*(ivaPorc/100);
  const totalFinal=subtotal+valorIva;

  document.getElementById("subtotal").innerText=formatear(subtotal);
  document.getElementById("valorIva").innerText=formatear(valorIva);
  document.getElementById("totalFinal").innerText=formatear(totalFinal);
}

document.addEventListener("input",function(e){
  if(e.target.closest("table") || 
     e.target.id==="precioM3" ||
     e.target.id==="espesor" ||
     e.target.id==="iva"){
    recalcular();
  }
});

function formatear(valor){
  return new Intl.NumberFormat('es-CO',{
    style:'currency',
    currency:'COP',
    minimumFractionDigits:0
  }).format(valor);
}

</script>

</body>
</html>
